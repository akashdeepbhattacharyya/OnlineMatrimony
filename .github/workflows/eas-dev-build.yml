name: EAS Dev Android Build

on:
  pull_request:
    types:
      - closed
    branches:
      - main
      
jobs:
  android-dev-apk:
    runs-on: ubuntu-latest
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸŸ¦ Setup Node 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”§ Install EAS CLI
        run: npm install -g eas-cli

      - name: ðŸ—ï¸ Trigger EAS Build (Android - development)
        run: eas build --platform android --profile development --non-interactive --json > build.json

      - name: ðŸ“¤ Upload build metadata
        uses: actions/upload-artifact@v4
        with:
          name: eas-build.json
          path: build.json

      - name: ðŸ”Ž Extract build URL
        id: extract-url
        run: |
          echo "APK URL:"
          cat build.json
          echo "details_url=$(jq -r '.[0].detailsUrl' build.json)" >> $GITHUB_OUTPUT

      - name: ðŸ’¬ Post comment on related PR
        if: ${{ github.event.head_commit.message != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const buildUrl = "${{ steps.extract-url.outputs.details_url }}";
            const commitSha = context.payload.head_commit.id;
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "closed",
              sort: "updated",
              direction: "desc",
              per_page: 10
            });

            const pr = prs.find(pr => pr.merge_commit_sha === commitSha);
            if (!pr) {
              console.log("No matching PR found.");
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `âœ… Dev APK is ready! [Download from EAS](${buildUrl})`
            });
